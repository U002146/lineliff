<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„å«è»Šæœå‹™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼·åˆ¶é˜²æ­¢ iOS ç¸®æ”¾ï¼Œä¸¦è¨­å®šåŸºç¤å­—é«”å¤§å° */
        input, select, textarea { font-size: 17px !important; } 
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* è‡ªå®šç¾©é¸å–®ç®­é ­ */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* å¿«é€Ÿæ¨™ç±¤çš„æ°´å¹³æ²å‹•éš±è—å·è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å¢åŠ  Placeholder çš„å°æ¯”åº¦ï¼Œè®“é•·è¼©çœ‹å¾—æ›´æ¸…æ¥š */
        ::placeholder { color: #9ca3af; opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4 w-12 h-12 border-4 text-blue-500"></div>
        <p id="loading-text" class="text-gray-500 font-bold text-lg">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <div id="app" class="hidden min-h-screen flex justify-center p-0 md:p-4">
        <div class="w-full max-w-md bg-white shadow-2xl rounded-none md:rounded-3xl overflow-hidden min-h-screen md:min-h-0 flex flex-col">
            
            <!-- Header -->
            <header class="bg-blue-600 text-white p-6 pb-8 rounded-b-[2.5rem] shadow-lg z-10 relative">
                <div class="text-center">
                    <h1 class="text-3xl font-extrabold tracking-wide">ğŸš• é ç´„å«è»Š</h1>
                    <p id="user-display" class="text-blue-100 text-base mt-2 font-medium">è¼‰å…¥ä½¿ç”¨è€…...</p>
                </div>
                <!-- è£é£¾ç”¨èƒŒæ™¯åœ“ -->
                <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-white opacity-10 rounded-full"></div>
                <div class="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 bg-white opacity-10 rounded-full"></div>
            </header>

            <!-- Form Container -->
            <div class="flex-1 overflow-y-auto p-6 -mt-6 relative z-20">
                <form id="booking-form" class="bg-white rounded-3xl shadow-md border border-gray-100 p-6 space-y-5">
                    <input type="hidden" id="name">
                    
                    <!-- è¯çµ¡é›»è©± -->
                    <div>
                        <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ“ è¯çµ¡é›»è©±</label>
                        <input type="tel" id="phone" required placeholder="09xx-xxx-xxx" inputmode="tel" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-lg shadow-sm placeholder-gray-400">
                    </div>

                    <!-- æ—¥æœŸèˆ‡æ™‚é–“ (Grid) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ“… æ—¥æœŸ</label>
                            <input type="date" id="date" required class="w-full p-4 bg-white border border-gray-200 rounded-2xl text-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ•’ æ™‚é–“</label>
                            <input type="time" id="time" required class="w-full p-4 bg-white border border-gray-200 rounded-2xl text-center text-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <!-- åœ°é»å€å¡Š -->
                    <div class="border-l-4 border-gray-100 pl-4 space-y-5 py-2">
                        
                        <!-- ä¸Šè»Šåœ°é» -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-lg font-bold text-green-600">ğŸŸ¢ ä¸Šè»Šåœ°é»</label>
                                <!-- å¿«é€Ÿè²¼ç´™ -->
                                <div class="flex space-x-1 overflow-x-auto no-scrollbar max-w-[60%]">
                                    <button type="button" onclick="setLoc('pickup', 'èŠ±è“®ç«è»Šç«™')" class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full whitespace-nowrap active:scale-95">ğŸš‰ ç«è»Šç«™</button>
                                    <button type="button" onclick="setLoc('pickup', 'æ…ˆæ¿Ÿé†«é™¢')" class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full whitespace-nowrap active:scale-95">ğŸ¥ æ…ˆæ¿Ÿ</button>
                                    <button type="button" onclick="setLoc('pickup', 'é–€è«¾é†«é™¢')" class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full whitespace-nowrap active:scale-95">ğŸ¥ é–€è«¾</button>
                                </div>
                            </div>
                            <input type="text" id="pickup" required placeholder="è«‹è¼¸å…¥ä¸Šè»Šè™•" class="w-full p-4 border border-gray-200 rounded-2xl text-lg shadow-sm focus:ring-2 focus:ring-green-500 outline-none placeholder-gray-400">
                        </div>

                        <!-- ä¸‹è»Šåœ°é» -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-lg font-bold text-red-600">ğŸ”´ ä¸‹è»Šåœ°é»</label>
                                <!-- å¿«é€Ÿè²¼ç´™ -->
                                <div class="flex space-x-1 overflow-x-auto no-scrollbar max-w-[60%]">
                                    <button type="button" onclick="setLoc('dropoff', 'èŠ±è“®ç«è»Šç«™')" class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full whitespace-nowrap active:scale-95">ğŸš‰ ç«è»Šç«™</button>
                                    <button type="button" onclick="setLoc('dropoff', 'æ…ˆæ¿Ÿé†«é™¢')" class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full whitespace-nowrap active:scale-95">ğŸ¥ æ…ˆæ¿Ÿ</button>
                                    <button type="button" onclick="setLoc('dropoff', 'é–€è«¾é†«é™¢')" class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full whitespace-nowrap active:scale-95">ğŸ¥ é–€è«¾</button>
                                </div>
                            </div>
                            <input type="text" id="dropoff" required placeholder="è«‹è¼¸å…¥ç›®çš„åœ°" class="w-full p-4 border border-gray-200 rounded-2xl text-lg shadow-sm focus:ring-2 focus:ring-red-500 outline-none placeholder-gray-400">
                        </div>
                    </div>

                    <!-- ä»˜æ¬¾æ–¹å¼ -->
                    <div class="pt-2 border-t border-gray-100">
                        <label class="block font-bold text-gray-700 mb-2 text-lg">ğŸ’° ä»˜æ¬¾æ–¹å¼</label>
                        <select id="payment" class="w-full p-4 bg-yellow-50 border border-yellow-200 rounded-2xl text-lg font-medium text-gray-800 shadow-sm focus:ring-2 focus:ring-yellow-400 outline-none cursor-pointer">
                            <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option>
                            <option value="æ•¬è€å¡">ğŸ§“ æ•¬è€å¡ (65æ­²+)</option>
                            <option value="æ„›å¿ƒå¡">â¤ï¸ æ„›å¿ƒå¡ (èº«éšœ)</option>
                            <option value="ä¹˜è»Šåˆ¸">ğŸ« ä¹˜è»Šåˆ¸</option>
                            <option value="TWRQ">ğŸ“² TWRQ</option>
                            <option value="LINE PAY">ğŸ’³ LINE PAY</option>
                            <option value="APPLE PAY">ğŸ APPLE PAY</option>
                        </select>
                    </div>

                </form>
            </div>

            <!-- Footer Action -->
            <div class="p-6 bg-white border-t border-gray-100 z-30">
                <button id="submitBtn" onclick="confirmAndSubmit()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xl font-bold shadow-lg hover:shadow-xl active:scale-[0.98] transition-all flex justify-center items-center">
                    ç¢ºèªå«è»Š
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        const MY_LIFF_ID = "2008907691-v0O7W8d3"; // ä½ çš„ LIFF ID
        // ==========================================

        const dom = {
            loading: document.getElementById('loading-overlay'),
            app: document.getElementById('app'),
            userDisplay: document.getElementById('user-display'),
            btn: document.getElementById('submitBtn'),
            inputs: {
                name: document.getElementById('name'),
                phone: document.getElementById('phone'),
                date: document.getElementById('date'),
                time: document.getElementById('time'),
                pickup: document.getElementById('pickup'),
                dropoff: document.getElementById('dropoff'),
                payment: document.getElementById('payment')
            }
        };

        // å¿«é€Ÿå¡«å¯«åœ°é»
        window.setLoc = function(type, value) {
            const input = document.getElementById(type);
            input.value = value;
            // è¦–è¦ºå›é¥‹ï¼šé–ƒçˆä¸€ä¸‹èƒŒæ™¯
            input.classList.add('bg-gray-100');
            setTimeout(() => input.classList.remove('bg-gray-100'), 200);
        }

        // è¼‰å…¥ SDK
        function loadSDK(callback) {
            const script = document.createElement('script');
            script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
            script.onload = callback;
            document.head.appendChild(script);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            // è¨­å®šé è¨­æ™‚é–“
            const now = new Date();
            dom.inputs.date.valueAsDate = now;
            now.setHours(now.getHours() + 1);
            dom.inputs.time.value = now.toTimeString().substring(0,5);

            loadSDK(() => {
                liff.init({ liffId: MY_LIFF_ID }).then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    liff.getProfile().then(profile => {
                        dom.userDisplay.innerText = `Hi, ${profile.displayName}`;
                        dom.inputs.name.value = profile.displayName;
                        dom.loading.classList.add('hidden');
                        dom.app.classList.remove('hidden');
                    });
                });
            });
        };

        // è¼”åŠ©å‡½å¼ï¼šæ—¥æœŸæ ¼å¼åŒ– (ç§»é™¤å¹´ä»½ï¼Œè½‰ç‚º æœˆ/æ—¥ (é€±X))
        function formatDateFriendly(dateStr) {
            const d = new Date(dateStr);
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const week = weekDays[d.getDay()];
            return `${month}/${day} (é€±${week})`;
        }

        // äºŒæ¬¡ç¢ºèª + é€å‡º
        async function confirmAndSubmit() {
            const form = document.getElementById('booking-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // æ ¼å¼åŒ–æ—¥æœŸ
            const friendlyDate = formatDateFriendly(dom.inputs.date.value);

            const data = {
                pickup: dom.inputs.pickup.value,
                dropoff: dom.inputs.dropoff.value,
                date: dom.inputs.date.value,
                friendlyDate: friendlyDate, // ç”¨æ–¼é¡¯ç¤º
                time: dom.inputs.time.value,
                name: dom.inputs.name.value,
                phone: dom.inputs.phone.value,
                payment: dom.inputs.payment.value
            };

            // â˜…â˜…â˜… äºŒæ¬¡ç¢ºèªè¦–çª— â˜…â˜…â˜…
            const result = await Swal.fire({
                title: 'è«‹ç¢ºèªé ç´„è³‡æ–™',
                html: `
                    <div class="text-left bg-gray-50 p-4 rounded-lg text-sm space-y-2">
                        <p><span class="font-bold text-gray-500">ğŸ“… æ™‚é–“ï¼š</span>${data.friendlyDate} ${data.time}</p>
                        <p><span class="font-bold text-green-600">ğŸŸ¢ ä¸Šè»Šï¼š</span>${data.pickup}</p>
                        <p><span class="font-bold text-red-600">ğŸ”´ ä¸‹è»Šï¼š</span>${data.dropoff}</p>
                        <p><span class="font-bold text-yellow-600">ğŸ’° ä»˜æ¬¾ï¼š</span>${data.payment}</p>
                        <p><span class="font-bold text-gray-500">ğŸ“ é›»è©±ï¼š</span>${data.phone}</p>
                    </div>
                `,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'âœ… ç¢ºèªé ç´„', // æ”¹ç‚º "ç¢ºèªé ç´„"
                cancelButtonText: 'âŒ ä¿®æ”¹',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#d1d5db',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;

            // é–‹å§‹é€å‡º
            executeSubmission(data);
        }

        async function executeSubmission(data) {
            dom.btn.disabled = true;
            dom.btn.innerHTML = `<div class="loader mr-3"></div> è³‡æ–™å‚³é€ä¸­...`;
            dom.btn.classList.remove('from-green-500', 'to-emerald-600');
            dom.btn.classList.add('bg-gray-400', 'cursor-not-allowed');

            // ç§»é™¤åˆ†éš”ç·šï¼Œç²¾ç°¡æ–‡æ¡ˆ
            const msgText = `ğŸ—“ï¸ é ç´„å«è»Šç¢ºèªå–®\nğŸ‘¤ ä¹˜å®¢ï¼š${data.name}\nğŸ“ é›»è©±ï¼š${data.phone}\nğŸ“… æ™‚é–“ï¼š${data.friendlyDate} ${data.time}\nğŸ’° ä»˜æ¬¾ï¼š${data.payment}\nğŸŸ¢ ä¸Šè»Šï¼š${data.pickup}\nğŸ”´ ä¸‹è»Šï¼š${data.dropoff}`;

            try {
                if (liff.isInClient()) {
                    await liff.sendMessages([{ type: 'text', text: msgText }]);
                }

                // ç”¢ç”Ÿ Google Calendar Link
                // æ ¼å¼ï¼šhttps://calendar.google.com/calendar/render?action=TEMPLATE&text={æ¨™é¡Œ}&dates={é–‹å§‹æ™‚é–“}/{çµæŸæ™‚é–“}&details={è©³æƒ…}&location={åœ°é»}
                const startDateTime = new Date(`${data.date}T${data.time}`).toISOString().replace(/-|:|\.\d\d\d/g, "");
                // é è¨­è¡Œç¨‹ 1 å°æ™‚
                const endDateTime = new Date(new Date(`${data.date}T${data.time}`).getTime() + 3600000).toISOString().replace(/-|:|\.\d\d\d/g, "");
                const calTitle = encodeURIComponent(`ğŸš• è¨ˆç¨‹è»Šé ç´„ (${data.pickup} -> ${data.dropoff})`);
                const calDetails = encodeURIComponent(`å¸æ©Ÿé›»è©±ï¼š(è«‹å¾…ç¢ºèª)\nä»˜æ¬¾æ–¹å¼ï¼š${data.payment}`);
                const calLocation = encodeURIComponent(data.pickup);
                const googleCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${calTitle}&dates=${startDateTime}/${endDateTime}&details=${calDetails}&location=${calLocation}`;

                Swal.fire({
                    icon: 'success',
                    title: 'é ç´„æˆåŠŸï¼',
                    html: `
                        <p class="mb-4 text-gray-600">å¸æ©Ÿå°‡ç›¡å¿«èˆ‡æ‚¨è¯ç¹«</p>
                        <a href="${googleCalUrl}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200 transition-colors">
                            ğŸ“… åŠ å…¥è¡Œäº‹æ›†
                        </a>
                    `,
                    confirmButtonText: 'é—œé–‰è¦–çª—',
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    liff.closeWindow();
                });

            } catch (err) {
                console.error(err);
                if (!liff.isInClient()) {
                     alert("è«‹åœ¨ LINE App å…§é–‹å•Ÿæ­¤é é¢ä»¥å‚³é€è¨Šæ¯ã€‚\n\n" + msgText);
                } else {
                     alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
                }
                
                dom.btn.disabled = false;
                dom.btn.innerHTML = "ç¢ºèªå«è»Š";
                dom.btn.classList.add('from-green-500', 'to-emerald-600');
                dom.btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        }
    </script>
    <!-- å¼•å…¥ SweetAlert2 è®“æç¤ºæ›´å¥½çœ‹ -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
